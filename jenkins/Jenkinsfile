pipeline {
  agent any

  options {
    skipDefaultCheckout(true)
    timestamps()
    disableConcurrentBuilds()
    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20'))
    timeout(time: 45, unit: 'MINUTES')
  }
  triggers { githubPush() }

  parameters {
    choice(name: 'ENV', choices: ['dev', 'stage', 'prod'], description: 'Environnement cible (info)')
    string(name: 'IMAGE_TAG', defaultValue: '', description: 'Tag image (vide = BUILD_NUMBER)')
    booleanParam(name: 'PUSH_LATEST', defaultValue: true, description: 'Pousser aussi :latest')
    choice(name: 'DEPLOY_METHOD', choices: ['managed-identity', 'acr-admin'], description: 'Pull ACR via Managed Identity (recommandÃ©) ou ACR admin')
    booleanParam(name: 'SKIP_TRAIN', defaultValue: false, description: "Sauter lâ€™entrainement si artifacts/iris_model.pkl dÃ©jÃ  prÃ©sent")
    booleanParam(name: 'RUN_SMOKE_AFTER_DEPLOY', defaultValue: true, description: 'Tester / aprÃ¨s dÃ©ploiement')
    booleanParam(name: 'FAIL_ON_SMOKE', defaultValue: false, description: 'Ã‰chouer si Smoke Test KO')
  }

  environment {
    APP_NAME     = 'iris-ml-app'
    DOCKER_IMAGE = "${APP_NAME}"

    // FastAPI (80). Si Streamlit: mets 8501 et adapte STARTUP_CMD
    APP_PORT     = '80'
    STARTUP_CMD  = "python -m uvicorn serveur.app:app --host 0.0.0.0 --port ${APP_PORT}"

    AZ_LOCATION  = 'germanywestcentral'
    AZ_RG        = 'ml_rg'
    AZ_PLAN      = 'plan-jenkins'
    AZ_WEBAPP    = 'app-jenkis-ml'

    AZ_ACR_NAME  = 'mlregitery123'
    AZ_ACR_LOGIN = 'mlregitery123.azurecr.io'

    CALC_TAG     = "${params.IMAGE_TAG ?: BUILD_NUMBER}"
    IMG_LOCAL    = "${DOCKER_IMAGE}:${CALC_TAG}"
    IMG_LOCAL_L  = "${DOCKER_IMAGE}:latest"
    IMG_ACR      = "${AZ_ACR_LOGIN}/${DOCKER_IMAGE}:${CALC_TAG}"
    IMG_ACR_L    = "${AZ_ACR_LOGIN}/${DOCKER_IMAGE}:latest"
  }

  stages {
    stage('Checkout') {
      steps {
        milestone(1)
        echo 'ðŸ“¦ Checkout repository...'
        checkout scm
      }
    }

    stage('Verify Environment & Project') {
      steps {
        echo 'ðŸ” Checking tools & project files...'
        bat '''
          echo "=== Tools ==="
          git --version
          docker --version
          az --version
          echo.

          echo "=== Project Files ==="
          if exist "jenkins\\train.py" (echo OK: jenkins\\train.py) else (echo NO: jenkins\\train.py & exit /b 1)
          if exist "Dockerfile" (echo OK: Dockerfile) else (echo NO: Dockerfile & exit /b 1)
          if exist "serveur\\app.py" (echo OK: serveur\\app.py) else (echo WARN: serveur\\app.py absent)
          if exist "app.py" (echo OK: app.py) else (echo WARN: app.py absent)
          if exist "data\\Iris.csv" (echo OK: data\\Iris.csv) else (echo WARN: data\\Iris.csv manquant)
          if exist "artifacts\\iris_model.pkl" (echo FOUND: artifacts\\iris_model.pkl) else (echo NOT YET: artifacts\\iris_model.pkl)
        '''
      }
    }

    stage('Train Model') {
      when { expression { return !params.SKIP_TRAIN } }
      steps {
        echo 'ðŸ¤– Training ML model (inside Docker python:3.11-slim)...'
        bat '''
          if not exist "artifacts" mkdir artifacts

          rem Workspace -> /app ; artifacts -> /app/artifacts (Ã©criture autorisÃ©e)
          docker run --rm ^
            -v "%CD%":/app ^
            -v "%CD%\\artifacts":/app/artifacts ^
            -w /app python:3.11-slim sh -lc ^
              "pip install -q scikit-learn pandas numpy joblib && TEST_DATA_DIR=/app/artifacts python jenkins/train.py"
          IF ERRORLEVEL 1 exit /b 1

          if exist artifacts\\iris_model.pkl (echo "âœ… artifacts\\iris_model.pkl created") else (echo "âŒ Model file missing" & exit /b 1)
        '''
      }
    }

    stage('Prepare Model for Image') {
      steps {
        echo 'ðŸ“ Ensuring models/iris_model.pkl exists for image build...'
        bat '''
          if not exist "models" mkdir models
          if exist artifacts\\iris_model.pkl copy /Y artifacts\\iris_model.pkl models\\iris_model.pkl >NUL
          if exist models\\iris_model.pkl (echo OK: models\\iris_model.pkl) else (echo âŒ Missing models\\iris_model.pkl & exit /b 1)
        '''
      }
    }

    stage('Build Image') {
      steps {
        milestone(2)
        echo "ðŸ³ Building image ${IMG_LOCAL}..."
        bat '''
          docker build --pull -t %IMG_LOCAL% .
          IF ERRORLEVEL 1 exit /b 1
          docker tag %IMG_LOCAL% %IMG_LOCAL_L%
          docker images | findstr /I "%APP_NAME%"
        '''
      }
    }

    stage('Azure Login + Ensure Resources') {
      steps {
        echo 'ðŸ” Azure login (SP) & ensure RG/Plan/WebApp...'
        withCredentials([
          string(credentialsId: 'az-client-id',       variable: 'AZ_CLIENT_ID'),
          string(credentialsId: 'az-client-secret',   variable: 'AZ_CLIENT_SECRET'),
          string(credentialsId: 'az-tenant-id',       variable: 'AZ_TENANT_ID'),
          string(credentialsId: 'az-subscription-id', variable: 'AZ_SUBSCRIPTION_ID')
        ]) {
          bat '''
            az login --service-principal -u %AZ_CLIENT_ID% -p %AZ_CLIENT_SECRET% --tenant %AZ_TENANT_ID%
            IF ERRORLEVEL 1 exit /b 1
            az account set --subscription %AZ_SUBSCRIPTION_ID%
            IF ERRORLEVEL 1 exit /b 1

            az provider register -n Microsoft.ContainerRegistry
            az provider register -n Microsoft.Web

            az group show -n %AZ_RG% || az group create -n %AZ_RG% -l %AZ_LOCATION%
            IF ERRORLEVEL 1 exit /b 1

            az appservice plan show -g %AZ_RG% -n %AZ_PLAN% || az appservice plan create -g %AZ_RG% -n %AZ_PLAN% --is-linux --sku B1 -l %AZ_LOCATION%
            IF ERRORLEVEL 1 exit /b 1

            az webapp show -g %AZ_RG% -n %AZ_WEBAPP% || az webapp create -g %AZ_RG% -n %AZ_WEBAPP% -p %AZ_PLAN% --runtime "PYTHON:3.11"
            IF ERRORLEVEL 1 exit /b 1
          '''
        }
      }
    }

    stage('Push to ACR') {
      steps {
        echo 'â¬†ï¸ Push image to ACR...'
        bat '''
          az acr login --name %AZ_ACR_NAME%
          IF ERRORLEVEL 1 exit /b 1

          docker tag %IMG_LOCAL% %IMG_ACR%
          docker push %IMG_ACR%
          IF ERRORLEVEL 1 exit /b 1

          IF "%PUSH_LATEST%"=="true" (
            docker tag %IMG_LOCAL_L% %IMG_ACR_L%
            docker push %IMG_ACR_L%
            IF ERRORLEVEL 1 exit /b 1
          )

          az acr repository show-tags -n %AZ_ACR_NAME% --repository %APP_NAME% -o table
        '''
      }
    }

    stage('Deploy to Web App') {
      steps {
        script {
          if (params.DEPLOY_METHOD == 'acr-admin') {
            withCredentials([usernamePassword(credentialsId: 'acr-admin', usernameVariable: 'ACR_USERNAME', passwordVariable: 'ACR_PASSWORD')]) {
              bat '''
                az webapp config container set -g %AZ_RG% -n %AZ_WEBAPP% ^
                  --container-image-name %IMG_ACR% ^
                  --container-registry-url https://%AZ_ACR_LOGIN% ^
                  --container-registry-user %ACR_USERNAME% ^
                  --container-registry-password %ACR_PASSWORD%
                IF ERRORLEVEL 1 exit /b 1

                az webapp config appsettings set -g %AZ_RG% -n %AZ_WEBAPP% --settings WEBSITES_PORT=%APP_PORT% WEBSITES_CONTAINER_START_TIME_LIMIT=1800
                az webapp config set -g %AZ_RG% -n %AZ_WEBAPP% --startup-file "%STARTUP_CMD%"
                az webapp restart -g %AZ_RG% -n %AZ_WEBAPP%
                az webapp show -g %AZ_RG% -n %AZ_WEBAPP% --query defaultHostName -o tsv > webapp_fqdn.txt
                for /f "usebackq tokens=* delims=" %%i in ("webapp_fqdn.txt") do set FQDN=%%i
                echo %FQDN%>webapp_fqdn.txt
              '''
            }
          } else {
            withCredentials([string(credentialsId: 'az-subscription-id', variable: 'AZ_SUBSCRIPTION_ID')]) {
              bat '''
                az webapp identity assign -g %AZ_RG% -n %AZ_WEBAPP%
                IF ERRORLEVEL 1 exit /b 1

                for /f "tokens=*" %%i in ('az webapp show -g %AZ_RG% -n %AZ_WEBAPP% --query identity.principalId -o tsv') do set PRINCIPAL=%%i
                az role assignment create --assignee %PRINCIPAL% --role "AcrPull" --scope /subscriptions/%AZ_SUBSCRIPTION_ID%/resourceGroups/%AZ_RG%/providers/Microsoft.ContainerRegistry/registries/%AZ_ACR_NAME%
                IF ERRORLEVEL 1 exit /b 1

                az webapp config set -g %AZ_RG% -n %AZ_WEBAPP% --acr-use-identity true --acr-identity [system]
                IF ERRORLEVEL 1 exit /b 1

                az webapp config container set -g %AZ_RG% -n %AZ_WEBAPP% ^
                  --container-image-name %IMG_ACR% ^
                  --container-registry-url https://%AZ_ACR_LOGIN%
                IF ERRORLEVEL 1 exit /b 1

                az webapp config appsettings set -g %AZ_RG% -n %AZ_WEBAPP% --settings WEBSITES_PORT=%APP_PORT% WEBSITES_CONTAINER_START_TIME_LIMIT=1800
                az webapp config set -g %AZ_RG% -n %AZ_WEBAPP% --startup-file "%STARTUP_CMD%"
                az webapp restart -g %AZ_RG% -n %AZ_WEBAPP%

                az webapp show -g %AZ_RG% -n %AZ_WEBAPP% --query defaultHostName -o tsv > webapp_fqdn.txt
                for /f "usebackq tokens=* delims=" %%i in ("webapp_fqdn.txt") do set FQDN=%%i
                echo %FQDN%>webapp_fqdn.txt
              '''
            }
          }
        }
      }
    }

    stage('Smoke Test on Azure (optional)') {
      when { expression { return params.RUN_SMOKE_AFTER_DEPLOY } }
      steps {
        echo 'ðŸ©º Azure smoke test (/) â€” optionnel'
        bat '''
          if not exist webapp_fqdn.txt (echo "No FQDN file" & exit /b 0)
          set /p FQDN=<webapp_fqdn.txt
          for /f "tokens=* delims= " %%a in ("%FQDN%") do set FQDN=%%a
          echo Testing http://%FQDN%/

          powershell -NoProfile -Command "Start-Sleep -Seconds 20"

          powershell -NoProfile -Command ^
            "$ErrorActionPreference='SilentlyContinue';" ^
            "try{$r=Invoke-WebRequest http://%FQDN%/ -UseBasicParsing; if($r.StatusCode -lt 200 -or $r.StatusCode -ge 400){exit 2}}catch{exit 2}"
          if ERRORLEVEL 2 (
            echo "WARN: GET / failed on Azure"
            IF "%FAIL_ON_SMOKE%"=="true" exit /b 1
          )

          echo "âœ… Azure smoke test passed (non-blocking)"
        '''
      }
    }
  }

  post {
    always {
      echo 'ðŸ“¦ Archiving artifacts...'
      archiveArtifacts artifacts: 'artifacts/**, models/**, webapp_fqdn.txt', allowEmptyArchive: true
    }
    success {
      echo 'ðŸŽ‰ SUCCESS'
      powershell '''
        if (Test-Path "webapp_fqdn.txt") {
          $fqdn = (Get-Content "webapp_fqdn.txt" | Select-Object -First 1).Trim()
          Write-Host "Open:  http://$fqdn/"
          Write-Host "Docs:  http://$fqdn/docs    (si FastAPI)"
          Write-Host "Port:  (WEBSITES_PORT=$env:APP_PORT)"
        } else {
          Write-Host "FQDN not found (open Azure portal)."
        }
        exit 0
      '''
    }
    failure {
      echo 'âŒ PIPELINE FAILED - check logs'
    }
  }
}
